#!/usr/bin/env python3
"""
æ•°æ®åº“è¿ç§»CLIå·¥å…·

ä½¿ç”¨æ–¹æ³•:
  ./migrate status                 # æ˜¾ç¤ºè¿ç§»çŠ¶æ€
  ./migrate migrate                # æ‰§è¡Œæ‰€æœ‰å¾…è¿ç§»
  ./migrate migrate --target v1.1.0  # è¿ç§»åˆ°æŒ‡å®šç‰ˆæœ¬
  ./migrate detect                 # æ£€æµ‹å½“å‰æ•°æ®åº“çŠ¶æ€
  ./migrate create <description>   # åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬

ç¯å¢ƒå˜é‡:
  DATABASE_URL - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² (é»˜è®¤ä».envè¯»å–)
"""

import os
import sys
import argparse
from datetime import datetime

# æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from migrations.migration_manager import MigrationManager


def get_database_url():
    """ä»ç¯å¢ƒå˜é‡æˆ–.envæ–‡ä»¶è·å–æ•°æ®åº“URL"""
    # é¦–å…ˆå°è¯•ç¯å¢ƒå˜é‡
    db_url = os.getenv('DATABASE_URL')
    if db_url:
        return db_url
    
    # å°è¯•ä».envæ–‡ä»¶è¯»å–
    env_file = os.path.join(os.path.dirname(__file__), '.env')
    if os.path.exists(env_file):
        with open(env_file, 'r') as f:
            for line in f:
                if line.startswith('DATABASE_URL='):
                    return line.split('=', 1)[1].strip()
    
    # é»˜è®¤å€¼
    return 'postgresql://postgres:password@localhost:5432/pindata_dataset'


def create_migration(description: str):
    """åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬"""
    # ç”Ÿæˆç‰ˆæœ¬å· (ç®€å•é€’å¢)
    migrations_dir = os.path.join(os.path.dirname(__file__), 'migrations')
    
    # æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬
    latest_version = "v0.0.0"
    for filename in os.listdir(migrations_dir):
        if filename.endswith('_migration.py') and filename.startswith('v'):
            version = filename.split('_')[0]
            if version > latest_version:
                latest_version = version
    
    # é€’å¢ç‰ˆæœ¬å·
    major, minor, patch = map(int, latest_version[1:].split('.'))
    new_version = f"v{major}.{minor}.{patch + 1}"
    
    # ç”Ÿæˆæ–‡ä»¶å
    safe_description = description.lower().replace(' ', '_').replace('-', '_')
    filename = f"{new_version}_{safe_description}_migration.py"
    filepath = os.path.join(migrations_dir, filename)
    
    # è¯»å–æ¨¡æ¿
    template_path = os.path.join(migrations_dir, 'migration_template.py')
    with open(template_path, 'r') as f:
        template_content = f.read()
    
    # æ›¿æ¢æ¨¡æ¿å†…å®¹
    content = template_content.replace(
        'MIGRATION_VERSION = "v1.0.0"',
        f'MIGRATION_VERSION = "{new_version}"'
    ).replace(
        'MIGRATION_DESCRIPTION = "æ¨¡æ¿è¿ç§»è„šæœ¬"',
        f'MIGRATION_DESCRIPTION = "{description}"'
    ).replace(
        'MIGRATION_DATE = datetime.now().isoformat()',
        f'MIGRATION_DATE = "{datetime.now().isoformat()}"'
    )
    
    # å†™å…¥æ–‡ä»¶
    with open(filepath, 'w') as f:
        f.write(content)
    
    print(f"âœ… è¿ç§»è„šæœ¬å·²åˆ›å»º: {filename}")
    print(f"   è·¯å¾„: {filepath}")
    print(f"   è¯·ç¼–è¾‘è¯¥æ–‡ä»¶å®ç° up() å’Œ down() å‡½æ•°")


def main():
    parser = argparse.ArgumentParser(
        description='æ•°æ®åº“è¿ç§»ç®¡ç†å·¥å…·',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  ./migrate status                    # æŸ¥çœ‹è¿ç§»çŠ¶æ€
  ./migrate migrate                   # æ‰§è¡Œæ‰€æœ‰å¾…è¿ç§»
  ./migrate migrate --target v1.1.0  # è¿ç§»åˆ°æŒ‡å®šç‰ˆæœ¬
  ./migrate detect                    # æ£€æµ‹æ•°æ®åº“çŠ¶æ€
  ./migrate create "add user avatar"  # åˆ›å»ºæ–°è¿ç§»
        """
    )
    
    parser.add_argument(
        'command', 
        choices=['status', 'migrate', 'detect', 'create'],
        help='è¦æ‰§è¡Œçš„å‘½ä»¤'
    )
    
    parser.add_argument(
        'description',
        nargs='?',
        help='è¿ç§»æè¿° (ç”¨äºcreateå‘½ä»¤)'
    )
    
    parser.add_argument(
        '--target',
        help='ç›®æ ‡ç‰ˆæœ¬ (ç”¨äºmigrateå‘½ä»¤)'
    )
    
    parser.add_argument(
        '--database-url',
        default=get_database_url(),
        help='æ•°æ®åº“è¿æ¥URL'
    )
    
    parser.add_argument(
        '--dry-run',
        action='store_true',
        help='åªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¸å®é™…æ‰§è¡Œ'
    )
    
    args = parser.parse_args()
    
    if args.command == 'create':
        if not args.description:
            parser.error('createå‘½ä»¤éœ€è¦æä¾›æè¿°: ./migrate create "description"')
        create_migration(args.description)
        return
    
    # å…¶ä»–å‘½ä»¤éœ€è¦æ•°æ®åº“è¿æ¥
    try:
        manager = MigrationManager(args.database_url)
        
        if args.command == 'status':
            manager.status()
            
        elif args.command == 'migrate':
            if args.dry_run:
                pending = manager.get_pending_migrations()
                if pending:
                    print("å°†è¦æ‰§è¡Œçš„è¿ç§»:")
                    for m in pending:
                        print(f"  - {m['version']}: {m['filename']}")
                else:
                    print("æ²¡æœ‰å¾…æ‰§è¡Œçš„è¿ç§»")
            else:
                success = manager.migrate(args.target)
                sys.exit(0 if success else 1)
                
        elif args.command == 'detect':
            schema_info = manager.detect_current_schema()
            
            # æ ¹æ®æ£€æµ‹ç»“æœç»™å‡ºå»ºè®®
            if not schema_info['has_migration_table']:
                print("\nğŸ’¡ å»ºè®®:")
                print("   æ•°æ®åº“æ²¡æœ‰è¿ç§»ç®¡ç†è¡¨ï¼Œå»ºè®®è¿è¡Œ: ./migrate migrate")
            elif not schema_info['has_auth_system']:
                print("\nğŸ’¡ å»ºè®®:")
                print("   æ•°æ®åº“ç¼ºå°‘ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œå»ºè®®è¿è¡Œ: ./migrate migrate")
            else:
                print("\nâœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸")
    
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()