# 长文档处理指南

## 概述
本文档说明如何处理超长文档（1000+分块）的数据蒸馏任务。

## 处理策略

### 1. 自动分块
- 文档会自动按 `maxDocumentLength` 参数分块（默认50000字符）
- 超过1000块的文档会自动调整处理策略

### 2. 简化超时机制
- **普通文本**: 10分钟超时
- **长文本(20K+字符)**: 15分钟超时  
- **超长文本(50K+字符)**: 30分钟超时
- **长文档(100+块)**: 所有超时时间×1.5

### 3. 智能心跳检测
- **短文档(<100块)**: 每5分钟输出状态
- **中长文档(100-500块)**: 每10分钟输出状态
- **超长文档(500+块)**: 每15分钟输出状态

### 4. 进度报告频率
- **短文档(<100块)**: 每10块报告一次
- **中长文档(100-500块)**: 每20块报告一次
- **超长文档(500+块)**: 每50块报告一次

## 长文档处理时间估算

### 典型处理时间
- 每1000字符约需2-5秒（取决于LLM响应速度）
- 1000块文档预计需要：
  - 最快：2-3小时
  - 平均：8-12小时
  - 最慢：24-48小时

### 影响因素
1. **文档复杂度**: 技术文档比简单文本耗时更长
2. **LLM响应速度**: API延迟和并发限制
3. **网络状况**: 网络不稳定会增加重试时间
4. **系统资源**: CPU和内存使用情况

## 监控和管理

### 1. 实时监控
```bash
# 查看任务状态
python monitor_long_tasks.py

# 每30分钟自动检查（可放在cron中）
python monitor_long_tasks.py > logs/task_monitor_$(date +%Y%m%d_%H%M).log
```

### 2. 手动干预
```bash
# 终止卡死任务
python monitor_long_tasks.py kill <task_id>

# 查看详细日志
tail -f logs/celery_worker.log
```

## 最佳实践

### 1. 预处理建议
- 对于超大文档，考虑先手动分割
- 移除无用内容（如重复的页眉页脚）
- 统一文本格式和编码

### 2. 资源管理
- 确保足够的磁盘空间（建议至少剩余10GB）
- 监控内存使用，避免OOM
- 定期清理临时文件

### 3. 备份策略
- 定期保存中间结果
- 对于超长任务，考虑分批处理
- 保留原始数据备份

## 故障排查

### 1. 任务卡死
**症状**: 长时间无心跳输出
**排查步骤**:
1. 检查网络连接
2. 查看LLM API状态
3. 检查系统资源
4. 重启worker进程

### 2. 内存不足
**症状**: 任务异常终止，系统变慢
**解决方案**:
1. 减少并发任务数
2. 增加系统内存
3. 调整分块大小

### 3. 磁盘空间不足
**症状**: 写入失败错误
**解决方案**:
1. 清理临时文件
2. 增加磁盘空间
3. 调整输出路径

## 配置建议

### 1. 长文档专用配置
```json
{
  "maxDocumentLength": 30000,  // 减少分块大小
  "concurrency": 1,           // 降低并发数
  "enable_heartbeat": true,   // 启用心跳检测
  "backup_interval": 100      // 每100块备份一次
}
```

### 2. 系统资源配置
```bash
# 增加worker内存限制
export CELERY_WORKER_MAX_MEMORY_PER_CHILD=4000000  # 4GB

# 设置合理的并发数
export CELERY_WORKER_CONCURRENCY=2
```

## 常见问题

### Q: 1000块的文档需要多长时间？
A: 通常需要8-24小时，具体取决于文档复杂度和LLM响应速度。

### Q: 如何判断任务是否卡死？
A: 如果超过心跳间隔2倍时间没有输出，可能是卡死了。

### Q: 可以中途停止任务吗？
A: 可以，使用 `python monitor_long_tasks.py kill <task_id>` 停止任务。

### Q: 如何恢复中断的任务？
A: 目前需要重新开始，建议定期备份中间结果。

## 注意事项

1. **耐心等待**: 长文档处理是正常的，不要急于停止
2. **监控资源**: 定期检查系统资源使用情况
3. **备份重要**: 对于重要文档，建议分批处理
4. **测试先行**: 用小文档测试配置是否正确

---

*最后更新: 2024年* 